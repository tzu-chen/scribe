<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Study Roadmap — From Analysis to Stochastic Frontiers</title>
<script>
window.MathJax = {
  tex: { inlineMath: [['$','$']] },
  svg: { fontCache: 'global' },
  startup: {
    ready: () => {
      MathJax.startup.defaultReady();
      MathJax.startup.promise.then(() => {
        setTimeout(drawAllArrows, 500);
        window.addEventListener('resize', () => setTimeout(drawAllArrows, 200));
      });
    }
  }
};
</script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/3.2.2/es5/tex-svg.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=EB+Garamond:ital,wght@0,400;0,600;0,700;1,400&family=IBM+Plex+Mono:wght@400;500&display=swap');
  *{margin:0;padding:0;box-sizing:border-box;}
  body{background:#faf8f4;font-family:'EB Garamond',Georgia,serif;color:#2a2a28;}
  @media print{body{background:#fff;}.node{box-shadow:none!important;}}

  #chart{position:relative;width:1550px;height:3500px;margin:0 auto;padding:30px 0 60px;}
  #arrows{position:absolute;top:0;left:0;width:100%;height:100%;pointer-events:none;z-index:0;}

  .node{position:absolute;border-radius:6px;padding:12px 14px;z-index:1;
    box-shadow:0 1px 4px rgba(0,0,0,0.06);cursor:pointer;
    transition:opacity 0.3s,transform 0.3s,box-shadow 0.3s;}
  .node-title{font-size:0.9rem;font-weight:700;margin-bottom:2px;line-height:1.3;}
  .node-div{height:1px;margin:5px 0 7px;}
  .node-refs{font-size:0.74rem;line-height:1.55;}
  .node-topics{font-size:0.71rem;font-style:italic;margin-top:5px;line-height:1.45;}
  .node-feeds{font-size:0.66rem;margin-top:4px;opacity:0.5;}

  .node.dimmed{opacity:0.18;transform:scale(0.98);}
  .node.highlighted{box-shadow:0 2px 12px rgba(0,0,0,0.15);transform:scale(1.02);z-index:3;}
  .node.selected{box-shadow:0 3px 16px rgba(0,0,0,0.22);transform:scale(1.03);z-index:4;}

  .depth-badge{position:absolute;top:-8px;right:-8px;background:#4a4a40;color:#faf8f4;
    font-family:'IBM Plex Mono',monospace;font-size:0.55rem;font-weight:600;
    padding:2px 6px;border-radius:10px;z-index:5;opacity:0;transition:opacity 0.3s;pointer-events:none;}
  .node.highlighted .depth-badge,.node.selected .depth-badge{opacity:1;}

  /* Action icons toolbar */
  .node-actions{display:none;position:absolute;top:-8px;left:-8px;flex-direction:row;gap:3px;z-index:6;}
  .node.selected .node-actions{display:flex;}
  .node-action-btn{width:22px;height:22px;border-radius:50%;border:1px solid #b0ada4;background:#faf8f4;
    cursor:pointer;display:flex;align-items:center;justify-content:center;padding:0;
    transition:background 0.15s,border-color 0.15s;position:relative;}
  .node-action-btn:hover{background:#eae6dc;border-color:#8a8a80;}
  .node-action-btn svg{width:12px;height:12px;fill:none;stroke:#4a4a40;stroke-width:2;stroke-linecap:round;stroke-linejoin:round;}
  .node-action-btn:hover svg{stroke:#2a2a28;}
  .attach-count{position:absolute;top:-5px;right:-5px;background:#4263eb;color:#fff;
    font-family:'IBM Plex Mono',monospace;font-size:0.48rem;font-weight:700;
    min-width:13px;height:13px;line-height:13px;text-align:center;border-radius:7px;
    padding:0 3px;display:none;}
  .attach-count.has-files{display:block;}

  /* Stage 0: warm sand */
  .c0{background:#faf5ec;border:1.2px solid #d4c4a0;}
  .c0 .node-title{color:#7a6530;}.c0 .node-div{background:#d4c4a0;}
  .c0 .node-refs{color:#7a6a40;}.c0 .node-topics{color:#8a7a50;}

  /* Stage 1: warm peach */
  .c1{background:#faf0e8;border:1.2px solid #d4b098;}
  .c1 .node-title{color:#8a5030;}.c1 .node-div{background:#d4b098;}
  .c1 .node-refs{color:#7a5a40;}.c1 .node-topics{color:#8a6a50;}

  /* Stage 2: rose */
  .c2{background:#f8ece8;border:1.2px solid #d0a0a0;}
  .c2 .node-title{color:#7a3a3a;}.c2 .node-div{background:#d0a0a0;}
  .c2 .node-refs{color:#7a5050;}.c2 .node-topics{color:#8a6060;}

  /* Stage 3: mauve */
  .c3{background:#f2ecf4;border:1.2px solid #baa0c8;}
  .c3 .node-title{color:#5a3070;}.c3 .node-div{background:#baa0c8;}
  .c3 .node-refs{color:#6a4a7a;}.c3 .node-topics{color:#7a5a8a;}

  /* Stage 4: slate blue */
  .c4{background:#ecf0f6;border:1.2px solid #9ab0cc;}
  .c4 .node-title{color:#2a4a70;}.c4 .node-div{background:#9ab0cc;}
  .c4 .node-refs{color:#4a6080;}.c4 .node-topics{color:#5a7090;}
  .c4 .node-feeds{color:#6a8098;}

  /* Stage 5: deep teal */
  .c5{background:#eaf4f2;border:1px solid #88beb8;}
  .c5 .node-title{color:#1a5a50;}.c5 .node-div{background:#88beb8;}
  .c5 .node-refs{color:#3a6a60;}.c5 .node-topics{color:#4a7a70;}
  .c5 .node-feeds{color:#6a8a80;}

  .badge{display:inline-block;font-size:0.56rem;font-weight:600;letter-spacing:0.8px;padding:1px 5px;border-radius:3px;margin-left:5px;vertical-align:middle;font-family:'IBM Plex Mono',monospace;}
  .badge.open{background:#e8f2f0;border:1px solid #80b8b0;color:#1a5a50;}
  .badge.moon{background:#eaf0f4;border:1px solid #90b0c0;color:#2a4a60;}
  .badge.qft3{background:#e8f2f0;border:1px solid #80b8b0;color:#1a5a50;}
  .badge.timing{background:#ecf0f6;border:1px solid #9ab0cc;color:#2a4a70;}
  .badge.opt{background:#f0eef4;border:1px solid #b0a8c0;color:#5a4a70;}

  .stage-lbl{position:absolute;font-size:0.66rem;letter-spacing:4px;text-transform:uppercase;font-weight:600;z-index:2;transition:opacity 0.3s;}
  .chart-title{position:absolute;width:100%;text-align:center;top:6px;z-index:2;}
  .chart-title h1{color:#2a2a28;font-size:1.45rem;font-weight:700;letter-spacing:3px;text-transform:uppercase;}
  .chart-title .sub{color:#8a8a80;font-size:0.7rem;letter-spacing:5px;text-transform:uppercase;}

  .timeline-bar{position:absolute;display:flex;border-radius:5px;overflow:hidden;border:1px solid #d0ccc0;z-index:2;}
  .timeline-bar>div{padding:8px 6px;text-align:center;font-size:0.68rem;font-weight:700;}
  .tl-sub{font-weight:400;font-style:italic;font-size:0.6rem;opacity:0.7;margin-top:2px;}

  mjx-container{font-size:100%!important;}
</style>
</head>
<body>
<div id="chart">
  <svg id="arrows"><defs>
    <marker id="ah" viewBox="0 0 10 7" refX="9" refY="3.5" markerWidth="8" markerHeight="6" orient="auto"><polygon points="0 0.5,9 3.5,0 6.5" fill="#9a9a90"/></marker>
    <marker id="ah-hi" viewBox="0 0 10 7" refX="9" refY="3.5" markerWidth="8" markerHeight="6" orient="auto"><polygon points="0 0.5,9 3.5,0 6.5" fill="#5a5a50"/></marker>
    <marker id="ah-dim" viewBox="0 0 10 7" refX="9" refY="3.5" markerWidth="8" markerHeight="6" orient="auto"><polygon points="0 0.5,9 3.5,0 6.5" fill="#c0b8a8"/></marker>
  </defs></svg>

  <div class="chart-title">
    <h1>From Analysis to Stochastic Frontiers</h1>
    <div class="sub">A Study Roadmap</div>
  </div>

  <!-- ===== STAGE 0: y~95 ===== -->
  <div class="stage-lbl" style="left:50px;top:65px;color:#7a6530;">Stage 0 — Audit &amp; Fill (weeks 1–4)</div>

  <div class="node c0" id="topo" style="left:80px;top:100px;width:225px;">
    <div class="depth-badge"></div>
    <div class="node-title">0A. Point-Set Topology</div>
    <div class="node-div"></div>
    <div class="node-refs">Munkres (ch 1–5)</div>
    <div class="node-topics">Compactness, Arzelà-Ascoli, Baire category, Tychonoff</div>
  </div>

  <div class="node c0" id="linalg" style="left:370px;top:100px;width:225px;">
    <div class="depth-badge"></div>
    <div class="node-title">0B. Rigorous Linear Algebra</div>
    <div class="node-div"></div>
    <div class="node-refs">Axler or Roman</div>
    <div class="node-topics">Quotient/dual spaces, tensor products (universal property)</div>
  </div>

  <div class="node c0" id="complex" style="left:660px;top:100px;width:225px;">
    <div class="depth-badge"></div>
    <div class="node-title">0C. Complex Analysis</div>
    <div class="node-div"></div>
    <div class="node-refs">Ahlfors or Stein &amp; Shakarchi II</div>
    <div class="node-topics">Cauchy thm, conformal maps, normal families, Riemann mapping</div>
  </div>

  <!-- ===== STAGE 1: y~310 ===== -->
  <div class="stage-lbl" style="left:50px;top:275px;color:#8a5030;">Stage 1 — Core Analysis (months 1–5)</div>

  <div class="node c1" id="measure" style="left:150px;top:315px;width:270px;">
    <div class="depth-badge"></div>
    <div class="node-title">1A. Measure Theory &amp; Real Analysis</div>
    <div class="node-div"></div>
    <div class="node-refs">Folland (primary) · Bauer<br>Bogachev · Cohn · Halmos</div>
    <div class="node-topics">$L^p$ spaces, Radon–Nikodym, Fubini/Tonelli, convergence theorems, Riesz representation</div>
  </div>

  <div class="node c1" id="func" style="left:520px;top:315px;width:270px;">
    <div class="depth-badge"></div>
    <div class="node-title">1B. Functional Analysis</div>
    <div class="node-div"></div>
    <div class="node-refs">Reed &amp; Simon I · Brezis<br>Rudin · Conway · Lax</div>
    <div class="node-topics">Spectral theory, weak/weak$^*$ topologies, Hahn–Banach, compact operators</div>
  </div>

  <!-- ===== STAGE 2: y~540 ===== -->
  <div class="stage-lbl" style="left:50px;top:505px;color:#7a3a3a;">Stage 2 — Bridges &amp; Probability (months 4–8)</div>

  <div class="node c2" id="semigrp" style="left:60px;top:545px;width:235px;">
    <div class="depth-badge"></div>
    <div class="node-title">2A. Semigroups of Operators</div>
    <div class="node-div"></div>
    <div class="node-refs">Yosida (selected) or Pazy<br>Engel &amp; Nagel</div>
    <div class="node-topics">Hille-Yosida, generators, analytic semigroups, abstract Cauchy problem</div>
  </div>

  <div class="node c2" id="prob" style="left:350px;top:545px;width:300px;">
    <div class="depth-badge"></div>
    <div class="node-title">2B. Measure-Theoretic Probability</div>
    <div class="node-div"></div>
    <div class="node-refs">Durrett · Billingsley (both books)<br>Kallenberg · Klenke · Shiryaev</div>
    <div class="node-topics">Martingale convergence, weak convergence on $C[0,1]$ &amp; $D[0,1]$, conditional expectation as $L^2$ projection, characteristic functions</div>
  </div>

  <div class="node c2" id="fourier" style="left:710px;top:550px;width:245px;">
    <div class="depth-badge"></div>
    <div class="node-title">2C. Fourier / Littlewood-Paley <span class="badge opt">if GIP</span></div>
    <div class="node-div"></div>
    <div class="node-refs">Bahouri, Chemin &amp; Danchin<br>Grafakos</div>
    <div class="node-topics">LP decomposition, Besov spaces $B^s_{p,q}$, paraproducts</div>
  </div>

  <!-- ===== STAGE 3: y~780 ===== -->
  <div class="stage-lbl" style="left:50px;top:745px;color:#5a3070;">Stage 3 — PDEs &amp; Stochastic Calculus (months 7–14)</div>

  <div class="node c3" id="pde" style="left:100px;top:790px;width:280px;">
    <div class="depth-badge"></div>
    <div class="node-title">3A. Partial Differential Equations</div>
    <div class="node-div"></div>
    <div class="node-refs">Evans (ch 5–8, 10) · Gilbarg &amp; Trudinger<br>Lieberman · Crandall-Ishii-Lions</div>
    <div class="node-topics">Sobolev spaces, elliptic/parabolic regularity, Schauder estimates, heat kernel, viscosity solutions</div>
  </div>

  <div class="node c3" id="stoch" style="left:470px;top:785px;width:310px;">
    <div class="depth-badge"></div>
    <div class="node-title">3B. Stochastic Processes &amp; Itô Calculus</div>
    <div class="node-div"></div>
    <div class="node-refs">Revuz &amp; Yor · Karatzas &amp; Shreve<br>Rogers &amp; Williams · Protter · Le Gall</div>
    <div class="node-topics">BM, Itô calculus, Girsanov, SDE existence/uniqueness, Feller semigroups, martingale representation</div>
  </div>

  <!-- ===== STAGE 4 ROW 1: y~1040 ===== -->
  <div class="stage-lbl" style="left:50px;top:1005px;color:#2a4a70;">Stage 4 — Specializations (months 12–20)</div>

  <div class="node c4" id="gauss" style="left:50px;top:1050px;width:225px;">
    <div class="depth-badge"></div>
    <div class="node-title">4A. Inf-Dim Gaussian Analysis</div>
    <div class="node-div"></div>
    <div class="node-refs">Da Prato — <em>Inf-Dim Analysis</em><br>Janson · Bogachev</div>
    <div class="node-topics">Gaussian measures on Banach spaces, cylindrical Wiener process, chaos expansions, Cameron-Martin</div>
  </div>

  <div class="node c4" id="bsde" style="left:320px;top:1050px;width:240px;">
    <div class="depth-badge"></div>
    <div class="node-title">4B. BSDEs &amp; Stochastic Control</div>
    <div class="node-div"></div>
    <div class="node-refs">Touzi · Pardoux &amp; Rascanu<br>Fleming &amp; Soner · Pham</div>
    <div class="node-topics">BSDE/FBSDE theory, HJB equations, stochastic maximum principle, verification</div>
  </div>

  <div class="node c4" id="mall" style="left:605px;top:1050px;width:210px;">
    <div class="depth-badge"></div>
    <div class="node-title">4C. Malliavin Calculus</div>
    <div class="node-div"></div>
    <div class="node-refs">Nualart (both books)</div>
    <div class="node-topics">$D$, $\delta$ (Skorokhod), Clark-Ocone, density regularity, Wiener chaos</div>
  </div>

  <div class="node c4" id="rp" style="left:860px;top:1050px;width:225px;">
    <div class="depth-badge"></div>
    <div class="node-title">4D. Rough Paths</div>
    <div class="node-div"></div>
    <div class="node-refs">Friz &amp; Hairer · Friz &amp; Victoir<br>Lyons, Caruana &amp; Lévy</div>
    <div class="node-topics">$p$-variation, tensor algebra, signatures, rough DEs</div>
  </div>

  <!-- ===== STAGE 4 ROW 2: y~1280 ===== -->
  <div class="node c4" id="spde" style="left:50px;top:1290px;width:260px;">
    <div class="depth-badge"></div>
    <div class="node-title">4E. SPDEs / Regularity Structures</div>
    <div class="node-div"></div>
    <div class="node-refs">Da Prato &amp; Zabczyk · Hairer<br>GIP · Otto-Sauer-Smith-Weber</div>
    <div class="node-topics">Mild/weak solutions, subcriticality, renormalization, paracontrolled</div>
  </div>

  <div class="node c4" id="otld" style="left:360px;top:1290px;width:240px;">
    <div class="depth-badge"></div>
    <div class="node-title">4F. Optimal Transport &amp; Large Dev.</div>
    <div class="node-div"></div>
    <div class="node-refs">Villani · AGS · Santambrogio<br>Dembo &amp; Zeitouni · Varadhan</div>
    <div class="node-topics">Wasserstein, Benamou-Brenier, Freidlin-Wentzell</div>
  </div>

  <div class="node c4" id="ethier" style="left:650px;top:1290px;width:225px;">
    <div class="depth-badge"></div>
    <div class="node-title">4G. Markov Proc. Convergence <span class="badge opt">if McKV</span></div>
    <div class="node-div"></div>
    <div class="node-refs">Ethier &amp; Kurtz</div>
    <div class="node-topics">Martingale problems, generator convergence, tightness</div>
  </div>

  <div class="node c4" id="side" style="left:925px;top:1290px;width:260px;border-style:dashed;">
    <div class="depth-badge"></div>
    <div class="node-title">4H. ⟳ Duminil-Copin &amp; Stat Phys <span class="badge timing">side quest</span></div>
    <div class="node-div"></div>
    <div class="node-refs">Grimmett — <em>Percolation</em> &amp; <em>Random-Cluster</em><br>Friedli &amp; Velenik · Lawler (SLE)</div>
    <div class="node-topics">Parafermionic observables, discrete complex analysis, conformal invariance</div>
  </div>

  <!-- ===== STAGE 5 ROW 1: y~1550 ===== -->
  <div class="stage-lbl" style="left:50px;top:1515px;color:#1a5a50;">Stage 5 — Research Frontiers (months 18–30)</div>

  <div class="node c5" id="mfg" style="left:50px;top:1560px;width:250px;">
    <div class="depth-badge"></div>
    <div class="node-title">5A. Mean Field Games <span class="badge open">MOST OPEN</span></div>
    <div class="node-div"></div>
    <div class="node-refs">Carmona &amp; Delarue (2 vols)<br>Cardaliaguet · Sznitman · Jabin &amp; Wang</div>
    <div class="node-topics">McKean-Vlasov FBSDEs, master equation, common noise, propagation of chaos, singular kernels</div>
    <div class="node-feeds">↳ 4B + 4F (+ 4G for McKV)</div>
  </div>

  <div class="node c5" id="sq" style="left:350px;top:1560px;width:230px;">
    <div class="depth-badge"></div>
    <div class="node-title">5B. Stoch. Quantization / $\Phi^4_3$ <span class="badge qft3">QFT ★★★</span></div>
    <div class="node-div"></div>
    <div class="node-refs">Hairer (2014) · Barashkov &amp; Gubinelli<br>GIP (2015) · Albeverio &amp; Kusuoka</div>
    <div class="node-topics">Rigorous Euclidean QFT via SPDE. Polchinski flow.</div>
    <div class="node-feeds">↳ 4E + QFT background</div>
  </div>

  <div class="node c5" id="diff" style="left:630px;top:1560px;width:230px;">
    <div class="depth-badge"></div>
    <div class="node-title">5C. Diffusion Models / Score-Based</div>
    <div class="node-div"></div>
    <div class="node-refs">Song et al. · Föllmer (1986)<br>Chen et al. · Léonard</div>
    <div class="node-topics">OU $\to$ time-reversal. Schrödinger bridges $\leftrightarrow$ OT.</div>
    <div class="node-feeds">↳ 3B + 4F</div>
  </div>

  <div class="node c5" id="fp" style="left:910px;top:1560px;width:220px;">
    <div class="depth-badge"></div>
    <div class="node-title">5D. Free Prob. / Random Matrices</div>
    <div class="node-div"></div>
    <div class="node-refs">Anderson-Guionnet-Zeitouni<br>Male · Bourgade</div>
    <div class="node-topics">Traffic distributions, Dyson BM, universality.</div>
    <div class="node-feeds">↳ 2B + 1B</div>
  </div>

  <!-- ===== STAGE 5 ROW 2: y~1790 ===== -->
  <div class="node c5" id="ym" style="left:50px;top:1800px;width:230px;">
    <div class="depth-badge"></div>
    <div class="node-title">5E. Yang–Mills (Stochastic) <span class="badge moon">MOONSHOT</span></div>
    <div class="node-div"></div>
    <div class="node-refs">Chandra-Chevyrev-Hairer-Shen<br>Lévy (2017) · Cao (2023)</div>
    <div class="node-topics">Lattice $\to$ continuum. Gauge + lattice background useful.</div>
    <div class="node-feeds">↳ 4E + QFT (gauge, lattice)</div>
  </div>

  <div class="node c5" id="rv" style="left:330px;top:1800px;width:230px;">
    <div class="depth-badge"></div>
    <div class="node-title">5F. Rough Volatility</div>
    <div class="node-div"></div>
    <div class="node-refs">Gatheral et al. · Bayer-Friz-Gatheral<br>El Euch &amp; Rosenbaum</div>
    <div class="node-topics">Log-vol $\sim$ fBM, $H\!\approx\!0.1$. Breaks Markov.</div>
    <div class="node-feeds">↳ 4D + 4C</div>
  </div>

  <div class="node c5" id="lqg" style="left:610px;top:1800px;width:230px;">
    <div class="depth-badge"></div>
    <div class="node-title">5G. Liouville Quantum Gravity</div>
    <div class="node-div"></div>
    <div class="node-refs">Miller &amp; Sheffield · Gwynne et al.<br>Berestycki · Sheffield (GFF)</div>
    <div class="node-topics">SLE + GFF + Brownian map.</div>
    <div class="node-feeds">↳ 4H + 3B + 4A</div>
  </div>

  <div class="node c5" id="spt" style="left:890px;top:1800px;width:220px;">
    <div class="depth-badge"></div>
    <div class="node-title">5H. Stochastic Portfolio Theory</div>
    <div class="node-div"></div>
    <div class="node-refs">Fernholz · Karatzas &amp; Ruf<br>Atlas models</div>
    <div class="node-topics">Rank-based diffusions. Small &amp; approachable.</div>
    <div class="node-feeds">↳ 3B (direct)</div>
  </div>

  <!-- ===== TIMELINE ===== -->
  <div class="stage-lbl" style="left:50px;top:2030px;color:#8a8a80;">Approximate Timeline</div>
  <div class="timeline-bar" style="left:50px;top:2060px;width:1200px;">
    <div style="flex:2;background:#f6f0e4;color:#7a6530;">Wk 1–4<div class="tl-sub">Audit</div></div>
    <div style="flex:5;background:#f4ebe2;color:#8a5030;">Mo 1–5<div class="tl-sub">Core Analysis</div></div>
    <div style="flex:4;background:#f2e6e2;color:#7a3a3a;">Mo 4–8<div class="tl-sub">Bridges &amp; Prob.</div></div>
    <div style="flex:7;background:#ece6f0;color:#5a3070;">Mo 7–14<div class="tl-sub">PDEs + Stoch. Calc</div></div>
    <div style="flex:8;background:#e6ecf2;color:#2a4a70;">Mo 12–20<div class="tl-sub">Specializations</div></div>
    <div style="flex:12;background:#e4f0ee;color:#1a5a50;">Mo 18–30<div class="tl-sub">Frontiers</div></div>
  </div>
</div>

<script>
// ===== CORRECTED DEPENDENCY GRAPH =====
const prereqs = {
  // Stage 0
  topo: [],
  linalg: [],
  complex: [],
  // Stage 1
  measure: ['topo'],
  func: ['measure','linalg'],
  // Stage 2
  semigrp: ['func'],
  prob: ['measure','complex'],
  fourier: ['measure','func'],
  // Stage 3
  pde: ['measure','func','semigrp'],
  stoch: ['prob','semigrp'],
  // Stage 4
  gauss: ['func','stoch'],
  bsde: ['stoch','pde'],
  mall: ['gauss','stoch'],
  rp: ['stoch'],
  spde: ['gauss','pde','fourier','semigrp'],
  otld: ['measure','func','prob'],
  ethier: ['semigrp','stoch'],
  side: ['prob','complex'],
  // Stage 5
  mfg: ['bsde','otld','ethier','stoch'],
  sq: ['spde'],
  ym: ['spde'],
  diff: ['stoch','otld'],
  rv: ['rp','mall'],
  fp: ['prob','func'],
  lqg: ['side','stoch','gauss'],
  spt: ['stoch'],
};

// ===== HIGHLIGHT SYSTEM =====
function getAncestors(nodeId) {
  const depths = {}; depths[nodeId] = 0;
  const queue = [nodeId];
  while (queue.length > 0) {
    const cur = queue.shift();
    for (const p of (prereqs[cur]||[])) {
      if (!(p in depths)) { depths[p] = depths[cur]+1; queue.push(p); }
    }
  }
  return depths;
}

const allEdges = [];
for (const [n,ps] of Object.entries(prereqs)) for (const p of ps) allEdges.push([p,n]);

let selectedNode = null;

// ===== ACTION ICONS INJECTION =====
function getCleanTitle(nodeEl) {
  const titleEl = nodeEl.querySelector('.node-title');
  return titleEl ? titleEl.textContent.replace(/^\d+[A-Z]?\.\s*/, '').trim() : nodeEl.id;
}

function injectNodeActions() {
  document.querySelectorAll('.node').forEach(nodeEl => {
    if (nodeEl.querySelector('.node-actions')) return;

    const actions = document.createElement('div');
    actions.className = 'node-actions';

    // Write note (pencil)
    const writeBtn = document.createElement('button');
    writeBtn.className = 'node-action-btn';
    writeBtn.setAttribute('data-action', 'write-note');
    writeBtn.setAttribute('title', 'Write note');
    writeBtn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M17 3a2.83 2.83 0 0 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z"/></svg>';

    // Attach file (paperclip)
    const attachBtn = document.createElement('button');
    attachBtn.className = 'node-action-btn';
    attachBtn.setAttribute('data-action', 'attach-file');
    attachBtn.setAttribute('title', 'Attach file');
    attachBtn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M21.44 11.05l-9.19 9.19a6 6 0 0 1-8.49-8.49l9.19-9.19a4 4 0 0 1 5.66 5.66l-9.2 9.19a2 2 0 0 1-2.83-2.83l8.49-8.48"/></svg>';

    // View attachments (folder)
    const viewBtn = document.createElement('button');
    viewBtn.className = 'node-action-btn';
    viewBtn.setAttribute('data-action', 'view-attachments');
    viewBtn.setAttribute('title', 'View attachments');
    viewBtn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z"/></svg>';

    const badge = document.createElement('span');
    badge.className = 'attach-count';
    badge.setAttribute('data-node-id', nodeEl.id);
    badge.textContent = '0';
    viewBtn.appendChild(badge);

    // View notes (file-text)
    const notesBtn = document.createElement('button');
    notesBtn.className = 'node-action-btn';
    notesBtn.setAttribute('data-action', 'view-notes');
    notesBtn.setAttribute('title', 'View notes');
    notesBtn.innerHTML = '<svg viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/><polyline points="10 9 9 9 8 9"/></svg>';

    actions.appendChild(writeBtn);
    actions.appendChild(attachBtn);
    actions.appendChild(viewBtn);
    actions.appendChild(notesBtn);
    nodeEl.appendChild(actions);
  });
}

injectNodeActions();

// ===== RECEIVE ATTACHMENT COUNTS FROM PARENT =====
window.addEventListener('message', e => {
  if (e.data?.type === 'attachment-counts') {
    const counts = e.data.counts || {};
    document.querySelectorAll('.attach-count').forEach(badge => {
      const nodeId = badge.getAttribute('data-node-id');
      const nodeEl = document.getElementById(nodeId);
      if (!nodeEl) return;
      const nodeTitle = getCleanTitle(nodeEl);
      const count = counts[nodeTitle] || 0;
      badge.textContent = String(count);
      badge.classList.toggle('has-files', count > 0);
    });
  }
});

function highlightChain(nodeId) {
  if (selectedNode===nodeId){clearHighlight();return;}
  selectedNode=nodeId;
  const anc=getAncestors(nodeId), set=new Set(Object.keys(anc));
  const activeEdges=new Set();
  for(const[f,t]of allEdges)if(set.has(f)&&set.has(t))activeEdges.add(`${f}->${t}`);
  document.querySelectorAll('.node').forEach(el=>{
    const id=el.id,b=el.querySelector('.depth-badge');
    if(id===nodeId){el.classList.remove('dimmed','highlighted');el.classList.add('selected');b.textContent='selected';}
    else if(set.has(id)){el.classList.remove('dimmed','selected');el.classList.add('highlighted');const d=anc[id];b.textContent=d===1?'1 step':`${d} steps`;}
    else{el.classList.remove('highlighted','selected');el.classList.add('dimmed');b.textContent='';}
  });
  document.querySelectorAll('#arrows path[data-from]').forEach(p=>{
    const k=`${p.dataset.from}->${p.dataset.to}`;
    if(activeEdges.has(k)){p.setAttribute('stroke','#5a5a50');p.setAttribute('stroke-width','2');p.setAttribute('stroke-opacity','1');p.setAttribute('marker-end','url(#ah-hi)');p.removeAttribute('stroke-dasharray');}
    else{p.setAttribute('stroke-opacity','0.08');p.setAttribute('stroke-width','0.8');}
  });
  // Notify parent frame of node selection
  if (window.parent !== window) {
    const nodeEl = document.getElementById(nodeId);
    if (nodeEl) {
      window.parent.postMessage({ type: 'node-selected', nodeId: nodeId, nodeTitle: getCleanTitle(nodeEl) }, '*');
    }
  }
}

function clearHighlight(){
  selectedNode=null;
  document.querySelectorAll('.node').forEach(el=>{el.classList.remove('dimmed','highlighted','selected');el.querySelector('.depth-badge').textContent='';});
  drawAllArrows();
  // Notify parent frame of deselection
  if (window.parent !== window) {
    window.parent.postMessage({ type: 'node-deselected' }, '*');
  }
}

document.addEventListener('click',e=>{
  // Check if an action button was clicked
  const actionBtn = e.target.closest('.node-action-btn');
  if (actionBtn) {
    e.stopPropagation();
    e.preventDefault();
    const nodeEl = actionBtn.closest('.node');
    if (!nodeEl) return;
    const action = actionBtn.getAttribute('data-action');
    if (window.parent !== window) {
      window.parent.postMessage({
        type: 'node-action',
        action: action,
        nodeId: nodeEl.id,
        nodeTitle: getCleanTitle(nodeEl)
      }, '*');
    }
    return;
  }
  // Original node/background click logic
  const n=e.target.closest('.node');
  if(n&&n.id){e.stopPropagation();highlightChain(n.id);}else{clearHighlight();}
});

// ===== ARROW DRAWING =====
function ga(id,side){
  const el=document.getElementById(id);if(!el)return{x:0,y:0};
  const r=el.getBoundingClientRect(),c=document.getElementById('chart').getBoundingClientRect();
  const x=r.left-c.left,y=r.top-c.top,w=r.width,h=r.height;
  return{
    top:{x:x+w/2,y},bottom:{x:x+w/2,y:y+h},left:{x,y:y+h/2},right:{x:x+w,y:y+h/2},
    b20:{x:x+w*.2,y:y+h},b30:{x:x+w*.3,y:y+h},b40:{x:x+w*.4,y:y+h},b50:{x:x+w*.5,y:y+h},
    b60:{x:x+w*.6,y:y+h},b70:{x:x+w*.7,y:y+h},b80:{x:x+w*.8,y:y+h},
    t20:{x:x+w*.2,y},t30:{x:x+w*.3,y},t40:{x:x+w*.4,y},t50:{x:x+w*.5,y},
    t60:{x:x+w*.6,y},t70:{x:x+w*.7,y},t80:{x:x+w*.8,y},
  }[side]||{x:x+w/2,y:y+h/2};
}
function cub(a,b,c1dx,c1dy,c2dx,c2dy){return`M${a.x} ${a.y} C${a.x+c1dx} ${a.y+c1dy},${b.x+c2dx} ${b.y+c2dy},${b.x} ${b.y}`;}
function lin(a,b){return`M${a.x} ${a.y}L${b.x} ${b.y}`;}
function addP(svg,d,from,to,o={}){
  const p=document.createElementNS('http://www.w3.org/2000/svg','path');
  p.setAttribute('d',d);p.setAttribute('fill','none');
  p.setAttribute('stroke',o.c||'#aaa89e');p.setAttribute('stroke-width',o.w||'1.1');
  p.setAttribute('marker-end',`url(#${o.m||'ah'})`);
  if(o.d)p.setAttribute('stroke-dasharray',o.d);
  p.dataset.from=from;p.dataset.to=to;
  svg.appendChild(p);
}

function drawAllArrows(){
  const svg=document.getElementById('arrows');
  const defs=svg.querySelector('defs');svg.innerHTML='';svg.appendChild(defs);
  const ch=document.getElementById('chart');
  svg.setAttribute('width',ch.scrollWidth);svg.setAttribute('height',ch.scrollHeight);

  const DIM={c:'#c8c0b0',w:'0.85',d:'4,3',m:'ah-dim'};

  // === Stage 0 → 1 ===
  addP(svg, cub(ga('topo','bottom'),ga('measure','t30'), 0,45, -10,-45), 'topo','measure');
  addP(svg, cub(ga('linalg','bottom'),ga('func','t30'), 0,45, -10,-45), 'linalg','func');
  addP(svg, lin(ga('measure','right'),ga('func','left')), 'measure','func');

  // === Stage 0 → 2 (complex → prob) ===
  addP(svg, cub(ga('complex','bottom'),ga('prob','t70'), 0,120, 20,-60), 'complex','prob');

  // === Stage 1 → 2 ===
  addP(svg, cub(ga('func','b30'),ga('semigrp','t60'), -40,50, 20,-45), 'func','semigrp');
  addP(svg, cub(ga('measure','b50'),ga('prob','t30'), 10,50, -20,-50), 'measure','prob');
  addP(svg, cub(ga('measure','b80'),ga('fourier','t30'), 80,60, -30,-50), 'measure','fourier', DIM);
  addP(svg, cub(ga('func','b70'),ga('fourier','t50'), 30,50, -10,-50), 'func','fourier', DIM);

  // === Stage 2 → 3 ===
  addP(svg, cub(ga('semigrp','b40'),ga('pde','t30'), 10,45, -10,-45), 'semigrp','pde');
  addP(svg, cub(ga('semigrp','b70'),ga('stoch','t20'), 60,50, -40,-45), 'semigrp','stoch');
  addP(svg, cub(ga('prob','b40'),ga('stoch','t40'), 10,45, -10,-45), 'prob','stoch');
  // measure, func → pde (long arcs through open space)
  addP(svg, cub(ga('measure','b30'),ga('pde','t50'), -30,120, 10,-60), 'measure','pde', DIM);
  addP(svg, cub(ga('func','b50'),ga('pde','t70'), -20,110, 20,-55), 'func','pde', DIM);

  // === Stage 3 → 4 row 1 ===
  addP(svg, cub(ga('stoch','b20'),ga('gauss','t60'), -60,50, 20,-50), 'stoch','gauss');
  addP(svg, cub(ga('func','right'),ga('gauss','t30'), 80,220, -20,-50), 'func','gauss', DIM);
  addP(svg, cub(ga('stoch','b40'),ga('bsde','t50'), 0,50, 0,-50), 'stoch','bsde');
  addP(svg, cub(ga('pde','b60'),ga('bsde','t20'), 40,50, -30,-50), 'pde','bsde');
  addP(svg, cub(ga('stoch','b55'),ga('mall','t40'), 15,50, -10,-50), 'stoch','mall');
  addP(svg, lin(ga('gauss','right'),ga('mall','left')), 'gauss','mall');
  addP(svg, cub(ga('stoch','b75'),ga('rp','t40'), 50,50, -20,-50), 'stoch','rp');

  // === Stage 4 row 1 → row 2 ===
  addP(svg, cub(ga('gauss','b40'),ga('spde','t40'), 10,40, -10,-40), 'gauss','spde');
  addP(svg, cub(ga('pde','b40'),ga('spde','t60'), 50,130, 10,-55), 'pde','spde');
  addP(svg, cub(ga('fourier','b50'),ga('spde','t80'), -80,200, 30,-55), 'fourier','spde', DIM);
  addP(svg, cub(ga('semigrp','b50'),ga('spde','t20'), -10,250, -50,-60), 'semigrp','spde', DIM);

  // otld prereqs: measure, func, prob
  addP(svg, cub(ga('measure','right'),ga('otld','t20'), 120,310, -40,-50), 'measure','otld', DIM);
  addP(svg, cub(ga('func','b80'),ga('otld','t40'), 40,280, -10,-50), 'func','otld', DIM);
  addP(svg, cub(ga('prob','b60'),ga('otld','t60'), 20,200, 10,-50), 'prob','otld', DIM);

  // ethier prereqs: semigrp, stoch
  addP(svg, cub(ga('semigrp','b80'),ga('ethier','t30'), 80,240, -30,-50), 'semigrp','ethier', DIM);
  addP(svg, cub(ga('stoch','b85'),ga('ethier','t50'), 60,140, 0,-50), 'stoch','ethier', DIM);

  // side (Duminil-Copin) prereqs: prob, complex
  addP(svg, cub(ga('prob','b80'),ga('side','t30'), 100,200, -40,-60), 'prob','side');
  addP(svg, cub(ga('complex','b80'),ga('side','t60'), 60,380, 10,-60), 'complex','side', DIM);

  // === Stage 4 → 5 ===
  // mfg prereqs: bsde, otld, ethier, stoch
  addP(svg, cub(ga('bsde','b30'),ga('mfg','t40'), -20,50, 10,-50), 'bsde','mfg');
  addP(svg, cub(ga('otld','b30'),ga('mfg','t70'), -50,50, 20,-50), 'otld','mfg');
  addP(svg, cub(ga('ethier','b30'),ga('mfg','t80'), -120,50, 30,-50), 'ethier','mfg', DIM);
  addP(svg, cub(ga('stoch','b30'),ga('mfg','t20'), -60,240, -20,-50), 'stoch','mfg', DIM);

  // sq, ym prereqs: spde
  addP(svg, cub(ga('spde','b40'),ga('sq','t30'), 20,50, -20,-50), 'spde','sq');
  addP(svg, cub(ga('spde','b20'),ga('ym','t30'), -10,100, -10,-70), 'spde','ym');

  // diff prereqs: stoch, otld
  addP(svg, cub(ga('stoch','right'),ga('diff','t30'), 100,240, -20,-50), 'stoch','diff', DIM);
  addP(svg, cub(ga('otld','b60'),ga('diff','t50'), 20,50, -10,-50), 'otld','diff');

  // fp prereqs: prob, func
  addP(svg, cub(ga('prob','right'),ga('fp','t30'), 200,310, -20,-50), 'prob','fp', DIM);
  addP(svg, cub(ga('func','right'),ga('fp','t50'), 150,390, 10,-50), 'func','fp', DIM);

  // rv prereqs: rp, mall
  addP(svg, cub(ga('rp','b40'),ga('rv','t60'), -10,140, 10,-80), 'rp','rv');
  addP(svg, cub(ga('mall','b50'),ga('rv','t30'), 0,140, -20,-80), 'mall','rv');

  // lqg prereqs: side, stoch, gauss
  addP(svg, cub(ga('side','b50'),ga('lqg','t70'), -20,80, 20,-50), 'side','lqg');
  addP(svg, cub(ga('stoch','b60'),ga('lqg','t30'), 30,310, -30,-60), 'stoch','lqg', DIM);
  addP(svg, cub(ga('gauss','b70'),ga('lqg','t50'), 80,200, -10,-70), 'gauss','lqg', DIM);

  // spt prereqs: stoch
  addP(svg, cub(ga('stoch','right'),ga('spt','t40'), 180,310, -10,-50), 'stoch','spt', DIM);

  if(selectedNode)highlightChain(selectedNode);
}

setTimeout(drawAllArrows,700);
setTimeout(drawAllArrows,2200);
</script>
</body>
</html>